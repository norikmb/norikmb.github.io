---
import type { AdventCalendarYear } from '../content/config';
import { adventCalendarConfigs } from '../utils/adventCalendarConfig';

interface Props {
	year: AdventCalendarYear;
}

const { year } = Astro.props;
const config = adventCalendarConfigs[year];

// デフォルト値を使用（サーバーサイドでは参照元は取得できない）
const defaultCalendarInfo = {
	text: config.defaultText,
	day: config.defaultDay,
};
---

<div>
	<h3 id="calendar-text">
		この記事は <Fragment set:html={defaultCalendarInfo.text} />の
		<span>{defaultCalendarInfo.day}</span>日目の記事です。
	</h3>
	<p>このページにアクセスした参照元: <span id="referrer"></span></p>

	<script define:vars={{ config: JSON.stringify(config) }}>
		const referrer = document.referrer;
		const parsedConfig = JSON.parse(config);

		// 参照元を表示
		const referrerElement = document.getElementById('referrer');
		if (referrerElement) {
			referrerElement.innerText = referrer;
		}

		// 参照元に基づいてカレンダー情報を更新
		function updateCalendarInfo() {
			let calendarText = parsedConfig.defaultText;
			let calendarDay = parsedConfig.defaultDay;

			for (const pattern of parsedConfig.referrerPatterns) {
				if (referrer.includes(pattern.pattern)) {
					calendarText = pattern.text;
					calendarDay = pattern.day;
					break;
				}
			}

			const calendarElement = document.getElementById('calendar-text');
			if (calendarElement) {
				calendarElement.innerHTML = `この記事は ${calendarText}の<span>${calendarDay}</span>日目の記事です。`;
			}
		}

		updateCalendarInfo();
	</script>
</div>
